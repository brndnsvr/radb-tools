# Configuration Guide

## Table of Contents

- [Overview](#overview)
- [Configuration File](#configuration-file)
- [Configuration Options](#configuration-options)
- [Environment Variables](#environment-variables)
- [Configuration Commands](#configuration-commands)
- [Profiles and Multiple Configurations](#profiles-and-multiple-configurations)
- [Configuration Priority](#configuration-priority)
- [Common Configuration Scenarios](#common-configuration-scenarios)

## Overview

The RADb API Client uses a YAML configuration file to store settings. This guide covers all configuration options and how to manage them.

### Configuration File Location

**Default location:**
```
~/.radb-client/config.yaml
```

**Custom location:**
```bash
radb-client --config /path/to/config.yaml <command>
```

**Environment variable:**
```bash
export RADB_CONFIG=/path/to/config.yaml
radb-client <command>
```

### Quick Start

```bash
# Initialize configuration with defaults
radb-client config init

# View current configuration
radb-client config show

# Update a specific setting
radb-client config set api.timeout 60

# Validate configuration
radb-client config validate
```

## Configuration File

### File Structure

The configuration file is organized into three main sections:

```yaml
# API connection settings
api:
  base_url: https://api.radb.net
  source: RADB
  format: json
  timeout: 30

# User preferences
preferences:
  cache_dir: ~/.radb-client/cache
  history_dir: ~/.radb-client/history
  log_level: INFO
  max_snapshots: 100
  auto_snapshot: true
  output_format: table
  color: true

# Advanced settings (optional)
advanced:
  retry_attempts: 3
  retry_delay: 5
  connection_pool_size: 10
  verify_ssl: true
```

### Example Configuration File

```yaml
# RADb API Client Configuration
# Generated by: radb-client config init
# Date: 2025-10-29

api:
  # Base URL for the RADb API
  base_url: https://api.radb.net

  # Database source (currently only RADB is supported)
  source: RADB

  # Preferred data format (json or text)
  format: json

  # Request timeout in seconds
  timeout: 30

preferences:
  # Directory for caching current state
  cache_dir: ~/.radb-client/cache

  # Directory for historical snapshots
  history_dir: ~/.radb-client/history

  # Logging level (DEBUG, INFO, WARN, ERROR)
  log_level: INFO

  # Maximum number of historical snapshots to retain
  # Set to 0 for unlimited
  max_snapshots: 100

  # Automatically create snapshot on list operations
  auto_snapshot: true

  # Default output format (table, json, yaml)
  output_format: table

  # Enable colored output
  color: true

advanced:
  # Number of retry attempts for failed requests
  retry_attempts: 3

  # Initial delay between retries (seconds)
  # Uses exponential backoff: delay * 2^attempt
  retry_delay: 5

  # HTTP connection pool size
  connection_pool_size: 10

  # Verify SSL certificates (always true in production)
  verify_ssl: true
```

## Configuration Options

### API Section

#### `api.base_url`

**Description:** Base URL for the RADb API

**Type:** String (URL)

**Default:** `https://api.radb.net`

**Valid values:**
- `https://api.radb.net` (production)
- Custom URL for testing environments

**Example:**
```yaml
api:
  base_url: https://api.radb.net
```

**Command line:**
```bash
radb-client config set api.base_url https://api.radb.net
```

**Environment variable:**
```bash
export RADB_API_BASE_URL=https://api.radb.net
```

**Notes:**
- Must use HTTPS (HTTP not supported)
- Include protocol (https://)
- No trailing slash

---

#### `api.source`

**Description:** Database source identifier

**Type:** String

**Default:** `RADB`

**Valid values:**
- `RADB` (primary supported source)

**Example:**
```yaml
api:
  source: RADB
```

**Notes:**
- Currently only RADB is fully supported
- Future versions may support other IRR databases

---

#### `api.format`

**Description:** Preferred data format for API requests and responses

**Type:** String (enum)

**Default:** `json`

**Valid values:**
- `json` - JSON format (recommended)
- `text` - RPSL text format

**Example:**
```yaml
api:
  format: json
```

**When to use text format:**
- Compatibility with legacy tools
- When working directly with RPSL
- Debugging IRR-specific issues

---

#### `api.timeout`

**Description:** Request timeout in seconds

**Type:** Integer

**Default:** `30`

**Valid range:** 1 - 300

**Example:**
```yaml
api:
  timeout: 30
```

**Recommendations:**
- Default (30s): Normal operations
- Higher (60s+): Bulk operations, slow networks
- Lower (10s): Quick checks, fast networks

**Command line override:**
```bash
radb-client --timeout 60 route list
```

---

### Preferences Section

#### `preferences.cache_dir`

**Description:** Directory for caching current state

**Type:** String (path)

**Default:** `~/.radb-client/cache`

**Example:**
```yaml
preferences:
  cache_dir: ~/.radb-client/cache
```

**Alternative locations:**
```yaml
# Custom location
cache_dir: /var/cache/radb-client

# XDG Base Directory
cache_dir: ${XDG_CACHE_HOME}/radb-client

# Project-specific
cache_dir: ./cache
```

**Notes:**
- Directory created automatically if missing
- Requires read/write permissions
- Contains latest state snapshots
- Size depends on number of routes

---

#### `preferences.history_dir`

**Description:** Directory for historical snapshots

**Type:** String (path)

**Default:** `~/.radb-client/history`

**Example:**
```yaml
preferences:
  history_dir: ~/.radb-client/history
```

**Notes:**
- Stores timestamped snapshots
- Used for change tracking and diffs
- Managed automatically (old snapshots removed)
- Size controlled by `max_snapshots`

---

#### `preferences.log_level`

**Description:** Logging verbosity level

**Type:** String (enum)

**Default:** `INFO`

**Valid values:**
- `DEBUG` - Detailed debugging information
- `INFO` - Informational messages
- `WARN` - Warning messages only
- `ERROR` - Error messages only

**Example:**
```yaml
preferences:
  log_level: INFO
```

**What each level shows:**

**DEBUG:**
```
2025-10-29 12:00:00 DEBUG Request: GET /RADB/route
2025-10-29 12:00:00 DEBUG Response: 200 OK (125ms)
2025-10-29 12:00:00 DEBUG Parsed 45 route objects
2025-10-29 12:00:00 INFO Listed 45 routes
```

**INFO:**
```
2025-10-29 12:00:00 INFO Listed 45 routes
2025-10-29 12:00:00 INFO Snapshot created
```

**WARN:**
```
2025-10-29 12:00:00 WARN Rate limit approaching (10 requests remaining)
```

**ERROR:**
```
2025-10-29 12:00:00 ERROR Failed to authenticate: invalid API key
```

**Command line override:**
```bash
radb-client --log-level DEBUG route list
```

---

#### `preferences.max_snapshots`

**Description:** Maximum number of historical snapshots to retain

**Type:** Integer

**Default:** `100`

**Valid range:** 0 (unlimited) or 1-10000

**Example:**
```yaml
preferences:
  max_snapshots: 100
```

**Recommendations:**
- Default (100): ~2-3 months of daily snapshots
- Higher (500): Long-term historical analysis
- Lower (30): Minimal disk usage
- 0: Unlimited (manual cleanup required)

**Storage implications:**
```
Average snapshot size: 1-10 KB per route
100 routes = 100-1000 KB per snapshot
100 snapshots = 10-100 MB total
```

---

#### `preferences.auto_snapshot`

**Description:** Automatically create snapshots on list operations

**Type:** Boolean

**Default:** `true`

**Example:**
```yaml
preferences:
  auto_snapshot: true
```

**When enabled:**
- Snapshot created on every `route list`
- Enables automatic change detection
- `route diff` always works

**When disabled:**
- Manual snapshots only
- No automatic change tracking
- Useful for read-only operations or bulk queries

**Use cases for disabling:**
```bash
# Disable for one-time check
radb-client config set preferences.auto_snapshot false
radb-client route list
radb-client config set preferences.auto_snapshot true
```

---

#### `preferences.output_format`

**Description:** Default output format for commands

**Type:** String (enum)

**Default:** `table`

**Valid values:**
- `table` - Human-readable table
- `json` - JSON format
- `yaml` - YAML format

**Example:**
```yaml
preferences:
  output_format: table
```

**Table output:**
```
ROUTE              ORIGIN     DESCRIPTION
192.0.2.0/24       AS64500    Example route 1
198.51.100.0/24    AS64501    Example route 2
```

**JSON output:**
```json
[
  {
    "route": "192.0.2.0/24",
    "origin": "AS64500",
    "descr": "Example route 1"
  }
]
```

**YAML output:**
```yaml
- route: 192.0.2.0/24
  origin: AS64500
  descr: Example route 1
```

**Command line override:**
```bash
radb-client route list --format json
```

---

#### `preferences.color`

**Description:** Enable colored terminal output

**Type:** Boolean

**Default:** `true`

**Example:**
```yaml
preferences:
  color: true
```

**When enabled:**
- Errors shown in red
- Warnings in yellow
- Success messages in green
- Headers and emphasis in bold

**When to disable:**
- Non-interactive environments (CI/CD)
- Log file output
- Terminal doesn't support colors
- Personal preference

**Automatically disabled when:**
- Output piped to file or another command
- NO_COLOR environment variable set
- TERM=dumb

---

### Advanced Section

#### `advanced.retry_attempts`

**Description:** Number of retry attempts for failed requests

**Type:** Integer

**Default:** `3`

**Valid range:** 0 - 10

**Example:**
```yaml
advanced:
  retry_attempts: 3
```

**Retry logic:**
- Attempt 1: Immediate
- Attempt 2: After 5s delay
- Attempt 3: After 10s delay (exponential backoff)
- Attempt 4: After 20s delay

**When retried:**
- Network timeouts
- Temporary server errors (5xx)
- Connection failures

**Not retried:**
- Authentication errors (401)
- Validation errors (422)
- Not found errors (404)

---

#### `advanced.retry_delay`

**Description:** Initial delay between retries in seconds

**Type:** Integer

**Default:** `5`

**Valid range:** 1 - 60

**Example:**
```yaml
advanced:
  retry_delay: 5
```

**Exponential backoff:**
- Retry 1: `delay` seconds (5s)
- Retry 2: `delay * 2` seconds (10s)
- Retry 3: `delay * 4` seconds (20s)

---

#### `advanced.connection_pool_size`

**Description:** HTTP connection pool size

**Type:** Integer

**Default:** `10`

**Valid range:** 1 - 100

**Example:**
```yaml
advanced:
  connection_pool_size: 10
```

**Recommendations:**
- Default (10): Normal usage
- Higher (50): Concurrent operations
- Lower (1): Sequential operations only

**Notes:**
- Reuses connections for better performance
- Higher values use more memory
- Limited by system resources

---

#### `advanced.verify_ssl`

**Description:** Verify SSL/TLS certificates

**Type:** Boolean

**Default:** `true`

**Example:**
```yaml
advanced:
  verify_ssl: true
```

**Important:**
- Should always be `true` in production
- Only disable for testing with self-signed certificates
- Security risk if disabled

**Never disable unless:**
- Testing with development server
- Using self-signed certificates
- Explicitly instructed by administrator

---

## Environment Variables

Environment variables override configuration file settings.

### Variable Format

```
RADB_<SECTION>_<KEY>=value
```

**Examples:**
```bash
export RADB_API_BASE_URL=https://api.radb.net
export RADB_API_TIMEOUT=60
export RADB_PREFERENCES_LOG_LEVEL=DEBUG
export RADB_PREFERENCES_AUTO_SNAPSHOT=false
```

### All Environment Variables

```bash
# API settings
export RADB_API_BASE_URL=https://api.radb.net
export RADB_API_SOURCE=RADB
export RADB_API_FORMAT=json
export RADB_API_TIMEOUT=30

# Preferences
export RADB_PREFERENCES_CACHE_DIR=~/.radb-client/cache
export RADB_PREFERENCES_HISTORY_DIR=~/.radb-client/history
export RADB_PREFERENCES_LOG_LEVEL=INFO
export RADB_PREFERENCES_MAX_SNAPSHOTS=100
export RADB_PREFERENCES_AUTO_SNAPSHOT=true
export RADB_PREFERENCES_OUTPUT_FORMAT=table
export RADB_PREFERENCES_COLOR=true

# Advanced
export RADB_ADVANCED_RETRY_ATTEMPTS=3
export RADB_ADVANCED_RETRY_DELAY=5
export RADB_ADVANCED_CONNECTION_POOL_SIZE=10
export RADB_ADVANCED_VERIFY_SSL=true

# Credentials (for automation)
export RADB_USERNAME=user@example.com
export RADB_API_KEY=your-api-key

# Configuration file location
export RADB_CONFIG=/path/to/config.yaml
```

### CI/CD Example

```yaml
# .github/workflows/deploy.yml
env:
  RADB_USERNAME: ${{ secrets.RADB_USERNAME }}
  RADB_API_KEY: ${{ secrets.RADB_API_KEY }}
  RADB_PREFERENCES_LOG_LEVEL: DEBUG
  RADB_PREFERENCES_AUTO_SNAPSHOT: false

steps:
  - name: Deploy routes
    run: radb-client route create routes.json
```

## Configuration Commands

### Initialize Configuration

Create default configuration file:

```bash
radb-client config init
```

**Options:**
```bash
# Force overwrite existing config
radb-client config init --force

# Use custom location
radb-client config init --config /path/to/config.yaml
```

---

### View Configuration

Display current configuration:

```bash
# Show all settings
radb-client config show

# Show specific section
radb-client config show api
radb-client config show preferences

# Show as JSON
radb-client config show --format json

# Show with sources (file, env var, default)
radb-client config show --sources
```

**Example output with sources:**
```
api.base_url: https://api.radb.net (default)
api.timeout: 60 (environment variable: RADB_API_TIMEOUT)
preferences.log_level: DEBUG (config file)
```

---

### Set Configuration Value

Update a specific configuration value:

```bash
radb-client config set <key> <value>
```

**Examples:**
```bash
# Set timeout
radb-client config set api.timeout 60

# Set log level
radb-client config set preferences.log_level DEBUG

# Disable auto-snapshot
radb-client config set preferences.auto_snapshot false

# Set custom cache directory
radb-client config set preferences.cache_dir /var/cache/radb
```

---

### Get Configuration Value

Retrieve a specific configuration value:

```bash
radb-client config get <key>
```

**Examples:**
```bash
radb-client config get api.timeout
# Output: 30

radb-client config get preferences.log_level
# Output: INFO
```

---

### Validate Configuration

Check configuration for errors:

```bash
radb-client config validate
```

**Checks:**
- Valid YAML syntax
- Required fields present
- Valid value types
- Value ranges
- Directory permissions
- URL format

**Example output:**
```
✓ Configuration file syntax valid
✓ All required fields present
✓ All values within valid ranges
✗ Warning: cache_dir does not exist (will be created)
✓ Configuration is valid
```

---

### Reset Configuration

Reset to defaults:

```bash
# Reset entire configuration
radb-client config reset

# Reset specific section
radb-client config reset api
radb-client config reset preferences

# Reset specific value
radb-client config reset api.timeout
```

---

## Profiles and Multiple Configurations

### Using Multiple Configurations

Manage different environments:

**Development:**
```bash
# ~/.radb-client/config-dev.yaml
api:
  base_url: https://dev-api.radb.net
preferences:
  log_level: DEBUG
```

**Production:**
```bash
# ~/.radb-client/config-prod.yaml
api:
  base_url: https://api.radb.net
preferences:
  log_level: INFO
```

**Usage:**
```bash
# Development
radb-client --config ~/.radb-client/config-dev.yaml route list

# Production
radb-client --config ~/.radb-client/config-prod.yaml route list
```

### Configuration Aliases

Create shell aliases for convenience:

```bash
# ~/.bashrc or ~/.zshrc
alias radb-dev='radb-client --config ~/.radb-client/config-dev.yaml'
alias radb-prod='radb-client --config ~/.radb-client/config-prod.yaml'
```

**Usage:**
```bash
radb-dev route list
radb-prod route list
```

### Environment-Based Configuration

```bash
#!/bin/bash
# run-radb.sh

ENVIRONMENT=${1:-dev}
CONFIG_FILE="$HOME/.radb-client/config-$ENVIRONMENT.yaml"

if [ ! -f "$CONFIG_FILE" ]; then
  echo "Configuration not found: $CONFIG_FILE"
  exit 1
fi

radb-client --config "$CONFIG_FILE" "${@:2}"
```

**Usage:**
```bash
./run-radb.sh dev route list
./run-radb.sh prod route list
```

## Configuration Priority

Settings are applied in this order (later overrides earlier):

1. **Default values** (built-in)
2. **Configuration file** (`~/.radb-client/config.yaml`)
3. **Environment variables** (`RADB_*`)
4. **Command-line flags** (`--timeout`, `--format`, etc.)

**Example priority:**
```yaml
# config.yaml
api:
  timeout: 30  # Priority 2
```

```bash
export RADB_API_TIMEOUT=45  # Priority 3 (overrides config file)

radb-client --timeout 60 route list  # Priority 4 (overrides env var)
# Effective timeout: 60
```

## Common Configuration Scenarios

### Scenario 1: Development Setup

```yaml
api:
  base_url: https://dev-api.radb.net
  timeout: 60

preferences:
  log_level: DEBUG
  cache_dir: ./dev-cache
  history_dir: ./dev-history
  auto_snapshot: false  # Manual snapshots for testing
  output_format: json
  color: true

advanced:
  verify_ssl: false  # Development only!
```

---

### Scenario 2: Production Setup

```yaml
api:
  base_url: https://api.radb.net
  timeout: 30

preferences:
  log_level: INFO
  cache_dir: /var/cache/radb-client
  history_dir: /var/lib/radb-client/history
  max_snapshots: 365  # Keep 1 year
  auto_snapshot: true
  output_format: table
  color: true

advanced:
  retry_attempts: 5
  retry_delay: 10
  verify_ssl: true
```

---

### Scenario 3: CI/CD Setup

```yaml
api:
  base_url: https://api.radb.net
  timeout: 60

preferences:
  log_level: INFO
  cache_dir: /tmp/radb-cache
  history_dir: /tmp/radb-history
  auto_snapshot: false  # No snapshots in CI
  output_format: json  # Machine-readable
  color: false  # No colors in logs

advanced:
  retry_attempts: 5
  retry_delay: 10
```

---

### Scenario 4: Minimal Disk Usage

```yaml
preferences:
  max_snapshots: 10  # Keep only 10 snapshots
  auto_snapshot: false  # Manual snapshots only
```

---

### Scenario 5: High-Volume Operations

```yaml
api:
  timeout: 120  # Longer timeout

preferences:
  auto_snapshot: false  # Don't snapshot during bulk ops

advanced:
  retry_attempts: 5
  retry_delay: 3
  connection_pool_size: 50  # More connections
```

---

## Troubleshooting Configuration

### Configuration Not Found

**Error:**
```
Error: Configuration file not found: ~/.radb-client/config.yaml
```

**Solution:**
```bash
radb-client config init
```

---

### Permission Denied

**Error:**
```
Error: Permission denied: ~/.radb-client/config.yaml
```

**Solution:**
```bash
chmod 600 ~/.radb-client/config.yaml
```

---

### Invalid YAML Syntax

**Error:**
```
Error: Failed to parse configuration: yaml: line 5: mapping values are not allowed in this context
```

**Solution:**
- Check YAML indentation (use spaces, not tabs)
- Validate syntax: https://www.yamllint.com/
- Use `radb-client config validate`

---

### Directory Creation Failed

**Error:**
```
Error: Failed to create cache directory: permission denied
```

**Solution:**
```bash
# Change to writable location
radb-client config set preferences.cache_dir ~/radb-cache

# Or create with proper permissions
sudo mkdir -p /var/cache/radb-client
sudo chown $USER /var/cache/radb-client
```

---

## Best Practices

1. **Keep configuration in version control**
   ```bash
   # .gitignore
   config.yaml  # If contains sensitive data

   # But commit example config
   git add config.example.yaml
   ```

2. **Use environment variables for secrets**
   ```bash
   export RADB_USERNAME=$RADB_USER
   export RADB_API_KEY=$RADB_KEY
   ```

3. **Document custom configurations**
   ```yaml
   # config-prod.yaml
   # Production configuration for team X
   # Owner: team-x@example.com
   # Last updated: 2025-10-29
   ```

4. **Validate after changes**
   ```bash
   radb-client config set api.timeout 60
   radb-client config validate
   ```

5. **Backup configurations**
   ```bash
   cp ~/.radb-client/config.yaml ~/.radb-client/config.yaml.backup
   ```

## See Also

- [User Guide](USER_GUIDE.md) - Getting started
- [Security](SECURITY.md) - Credential management
- [Troubleshooting](TROUBLESHOOTING.md) - Common issues
- [Commands](COMMANDS.md) - Command reference
